name: Docker Image

on:
  pull_request:
  push:
    branches:
      - develop
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    concurrency:
      group: docker_image
      cancel-in-progress: false
    steps:
      - name: Check Docker version
        run: docker --version

      - name: Install Docker Buildx
        run: docker buildx create --use

      - name: Checkout code
        uses: actions/checkout@v3

      - name: Build Docker Image
        run: |
          docker build \
            --build-arg NODE_ENV=${{ secrets.NODE_ENV }} \
            --build-arg MONGO_PROD_DB=${{ secrets.MONGO_PROD_DB }} \
            --build-arg MONGO_DEV_DB=${{ secrets.MONGO_DEV_DB }} \
            --build-arg ADMIN_EMAIL=${{ secrets.ADMIN_EMAIL }} \
            --build-arg ADMIN_PASS=${{ secrets.ADMIN_PASS }} \
            --build-arg COORDINATOR_EMAIL=${{ secrets.COORDINATOR_EMAIL }} \
            --build-arg COORDINATOR_PASS=${{ secrets.COORDINATOR_PASS }} \
            -t my-image:latest .

      - name: Build and publish Docker Image
        uses: mr-smithers-excellent/docker-build-push@v5
        with:
          image: ${{ secrets.DOCKER_HUB_USERNAME }}/atlp-pulse-bn
          tags: latest
          registry: docker.io
          username: ${{ secrets.DOCKER_HUB_USERNAME }}
          password: ${{ secrets.DOCKER_HUB_PASSWORD }}
